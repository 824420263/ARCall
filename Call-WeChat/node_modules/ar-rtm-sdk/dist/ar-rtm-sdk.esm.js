/*!
  * ar-rtm-sdk v1.0.11
  * (c) 2023 anyRTM SDK
  * @license MIT
  */
var e={VERSION:"1.0.11",GATEWAY_ADDRESS:"https://rtmgw.agrtc.cn",GATEWAY_CONNECT_TIMEOUT:3e3,GATEWAY_CONNECT_INTERVAL_TIMES:2e3,GATEWAY_RETRY_TIMEOUT:12e5,LOGIN_TIMEOUT:12e3},t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},t(e,n)};function n(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var r=function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},r.apply(this,arguments)};function i(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{E(r.next(e))}catch(e){o(e)}}function a(e){try{E(r.throw(e))}catch(e){o(e)}}function E(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}E((r=r.apply(e,t||[])).next())}))}function o(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function s(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function a(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function E(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}var _,c=function(){function e(e){if(this._url="",this._wss=!0,this._port=443,this._timeout=6e4,"[object Object]"===Object.prototype.toString.call(e)){var t=e.url,n=e.wss,r=e.port,i=e.timeout;"string"==typeof t&&(this._url=t),"boolean"==typeof n&&(this._wss=n,this._port=n?443:80),"number"==typeof r&&(this._port=r),"number"==typeof i&&(this._timeout=i)}}return e.prototype.setRequestUrl=function(e){if("[object Object]"===Object.prototype.toString.call(e)){var t=e.url,n=e.wss,r=e.port;"string"==typeof t&&(this._url=t),"boolean"==typeof n&&(this._wss=n,this._port=n?443:80),"number"==typeof r&&(this._port=r)}},e.prototype.request=function(e,t,n){return this._sendUrlRequest(e,t,n)},e.prototype.post=function(e,t){return this.request(e,"POST",t)},e.prototype.get=function(e,t){return this.request(e,"GET",t)},e.prototype._sendUrlRequest=function(e,t,n,r){var i=this;return void 0===r&&(r=!0),new Promise((function(o,s){if(""!==i._url){var a=i._url;e&&(a=i._url+e);try{wx.getSystemInfo(),wx.request({url:a,timeout:i._timeout,method:t,header:{"content-type":"application/json"},data:n,complete:function(e){var t=e.statusCode;o(200===t?e.data:{code:-1,msg:e.errMsg})}})}catch(e){var E=new XMLHttpRequest,_=function(){200===E.status?o(JSON.parse(E.responseText)):s("NETWORK_RESPONSE_ERROR")};r&&(E.onreadystatechange=function(){4===E.readyState&&_()}),E.open(t,a,r),E.onerror=function(e){s("NETWORK_ERROR")},E.ontimeout=function(){s("NETWORK_TIMEOUT")},E.send(JSON.stringify(n)),r||_()}}else s("NO_REQUEST_URL")}))},e}(),u={generateLowCaseString:function(e){void 0===e&&(e=7);var t=Math.random().toString(16).substr(2,e).toLowerCase();return t.length===e?t:t+this.generateLowCaseString(e-t.length)},generateUpperCaseString:function(e){return this.generateLowCaseString(e||32).toUpperCase()},getByteLength:function(e){for(var t=0,n=0;n<e.length;n++)e.charCodeAt(n)>255?t+=2:t++;return t}},R=function(e,t){var n="YYYY-MM-DD hh:mm:ss";if("number"!=typeof e)throw new Error("[timesToDate]: timestamp must be number");t&&"string"==typeof t&&(n=t);var r=e||Date.now(),i=new Date(r)||new Date(r),o=i.getFullYear(),s=i.getMonth()+1,a=i.getDate(),E=i.getHours(),_=i.getMinutes(),c=i.getSeconds();return n.indexOf("YYYY")>-1&&(n=n.replace("YYYY",(function(){return""+o}))),n.indexOf("MM")>-1?n=n.replace("MM",(function(){return s<10?"0"+s:""+s})):n.indexOf("M")>-1&&(n=n.replace("M",(function(){return""+s}))),n.indexOf("DD")>-1?n=n.replace("DD",(function(){return a<10?"0"+a:""+a})):n.indexOf("D")>-1&&(n=n.replace("D",(function(){return""+a}))),n.indexOf("hh")>-1?n=n.replace("hh",(function(){return E<10?"0"+E:""+E})):n.indexOf("h")>-1&&(n=n.replace("h",(function(){return""+E}))),n.indexOf("mm")>-1?n=n.replace("mm",(function(){return _<10?"0"+_:""+_})):n.indexOf("m")>-1&&(n=n.replace("m",(function(){return""+_}))),n.indexOf("ss")>-1?n=n.replace("ss",(function(){return c<10?"0"+c:""+c})):n.indexOf("s")>-1&&(n=n.replace("s",(function(){return""+c}))),n},l=function(e){void 0===e&&(e=13),e>20&&(e=20);var t=Math.ceil(Math.random()*Math.pow(10,e));return t<Math.pow(10,e-1)?l(e):t},N=function(e,t){var n=this;this.onFinally=t,this.promise=new Promise((function(t,r){return i(n,void 0,void 0,(function(){return o(this,(function(n){switch(n.label){case 0:return this.resolve=t,this.reject=r,e?[4,e(t,r)]:[3,2];case 1:n.sent(),n.label=2;case 2:return[2]}}))}))})).finally((function(){var e;return null===(e=n.onFinally)||void 0===e?void 0:e.call(n)}))};!function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARNING=2]="WARNING",e[e.ERROR=3]="ERROR",e[e.NONE=4]="NONE"}(_||(_={}));var I,d=new(function(){function e(){this.logPrefix="SupLogger",this.logLevel=_.NONE,this.uploadServeTranslators=[],this.DEBUG=_.DEBUG,this.INFO=_.INFO,this.WARNING=_.WARNING,this.ERROR=_.ERROR,this.NONE=_.NONE}return e.prototype.use=function(e){"function"==typeof e&&this.uploadServeTranslators.push((function(t,n){e(t,n)}))},e.prototype.setLogLevel=function(e,t){t&&(this.logPrefix=t),"number"==typeof e&&e>-1&&e<5&&(this.logLevel=e)},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(!(this.logLevel>_.ERROR&&this.logLevel!==_.NONE||this.logLevel===_.NONE)){var n=e,r=Date.now();n.unshift("["+R(r,"hh:mm:ss:ms")+"] %c"+this.logPrefix+" [ERROR]:%c","color: #b00020; font-weight: bold;","color: #dc3545;"),this.uploadServeTranslators.length>0?this.uploadServeTranslators.map((function(e){e({type:"error",params:n,timestamp:r},(function(){console.error.apply(console,n)}))})):console.error.apply(console,n)}},e.prototype.warning=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(!(this.logLevel>_.WARNING&&this.logLevel!==_.NONE||this.logLevel===_.NONE)){var n=e,r=Date.now();n.unshift("["+R(r,"hh:mm:ss:ms")+"] %c"+this.logPrefix+" [WARNING]:","color: #ffc107; font-weight: bold;"),this.uploadServeTranslators.length>0?this.uploadServeTranslators.map((function(e){e({type:"warning",params:n,timestamp:r},(function(){console.warn.apply(console,n)}))})):console.warn.apply(console,n)}},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(!(this.logLevel>_.INFO&&this.logLevel!==_.NONE||this.logLevel===_.NONE)){var n=e,r=Date.now();n.unshift("["+R(r,"hh:mm:ss:ms")+"] %c"+this.logPrefix+" [INFO]:","color:  #007bff; font-weight: bold;"),this.uploadServeTranslators.length>0?this.uploadServeTranslators.map((function(e){e({type:"info",params:n,timestamp:r},(function(){console.log.apply(console,n)}))})):console.log.apply(console,n)}},e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(!(this.logLevel>_.DEBUG&&this.logLevel!==_.NONE||this.logLevel===_.NONE)){var n=e,r=Date.now();n.unshift("["+R(r,"hh:mm:ss.ms")+"] %c"+this.logPrefix+" [DEBUG]:","color:#6facff;"),this.uploadServeTranslators.length>0?this.uploadServeTranslators.map((function(e){e({type:"debug",params:n,timestamp:r},(function(){console.log.apply(console,n)}))})):console.log.apply(console,n)}},e}());d.setLogLevel(d.DEBUG,"ar-rtm-sdk"),function(e){e.INVALID_PARAMS="INVALID_PARAMS",e.DEVELOPER_INVALID="DEVELOPER_INVALID",e.UID_BANNED="UID_BANNED",e.IP_BANNED="IP_BANNED",e.CHANNEL_BANNED="CHANNEL_BANNED",e.APPID_INVALID="APPID_INVALID",e.SERVER_NOT_OPEN="SERVER_NOT_OPEN",e.TOKEN_EXPIRED="TOKEN_EXPIRED",e.TOKEN_INVALID="TOKEN_INVALID",e.UNKNOWN="UNKNOWN",e.TIMEOUT="TIMEOUT"}(I||(I={}));var T=function(){function t(){this._urls=[],this._urlSuffix="/arapi/v1?action=",this._appid="",this._sessionId="",this.msgSuffix="/arapi/v1/artmgw/",this._urls=[e.GATEWAY_ADDRESS],this._urlSuffix="/arapi/v1?action="}return t.prototype.joinGateway=function(t,n){var s=this;void 0===t&&(t={});var a=this;return new Promise((function(E,_){var u=a._urlSuffix.concat("wrtm_gateway"),R=function(){return i(s,void 0,void 0,(function(){var i,s,l,N,T,O;return o(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,Promise.race(this._urls.map((function(n){return new c({url:n,timeout:e.GATEWAY_CONNECT_TIMEOUT}).post(u,r({},t))})))];case 1:if(i=o.sent())if(0===(s=i.code))l=i.sessionid,N=t.appid,a._sessionId=l,a._appid=N,E(i);else{if(-1===s||1===s)throw new Error("NETWORK_TIMEOUT");_(-4===s||-7===s||3===s?I.INVALID_PARAMS:13===s?I.DEVELOPER_INVALID:14===s?I.UID_BANNED:15===s?I.IP_BANNED:16===s?I.CHANNEL_BANNED:101===s||4===s?I.APPID_INVALID:102===s?I.SERVER_NOT_OPEN:109===s||6===s?I.TOKEN_EXPIRED:110===s||5===s?I.TOKEN_INVALID:"Error Code "+s+".")}return[3,3];case 2:return T=o.sent(),"NETWORK_ERROR"===(O=T)||"NETWORK_TIMEOUT"===O||"NETWORK_RESPONSE_ERROR"===O?(d.warning("reconnect gateway server, reason: "+O),Date.now()>n+e.LOGIN_TIMEOUT?(_(I.TIMEOUT),[2]):(setTimeout((function(){R()}),e.GATEWAY_CONNECT_INTERVAL_TIMES),[2])):(d.debug("XMLHttpRequest abort error ",O),_(I.UNKNOWN),[3,3]);case 3:return[2]}}))}))};R()}))},t.prototype.getChanHistoryMsg=function(t){return i(this,void 0,void 0,(function(){var n,s=this;return o(this,(function(a){return n=this,[2,new Promise((function(a,E){return i(s,void 0,void 0,(function(){var i,s;return o(this,(function(o){switch(o.label){case 0:return i=n.msgSuffix.concat("getChanHistoryMsg"),[4,new c({url:e.GATEWAY_ADDRESS,timeout:e.GATEWAY_CONNECT_TIMEOUT}).post(i,r(r({},t),{sessId:n._sessionId,appId:n._appid})).then((function(e){return e}))];case 1:return s=o.sent(),a(s),[2]}}))}))}))]}))}))},t.prototype.getOfflineMsg=function(t){return i(this,void 0,void 0,(function(){var n,s=this;return o(this,(function(a){return n=this,[2,new Promise((function(a,E){return i(s,void 0,void 0,(function(){var i,s;return o(this,(function(o){switch(o.label){case 0:return i=n.msgSuffix.concat("getOfflineMsg"),[4,new c({url:e.GATEWAY_ADDRESS,timeout:e.GATEWAY_CONNECT_TIMEOUT}).post(i,r(r({},t),{sessId:n._sessionId,appId:n._appid})).then((function(e){return e}))];case 1:return s=o.sent(),a(s),[2]}}))}))}))]}))}))},t.prototype.getP2PHistoryMsg=function(t){var n=this,s=this;return new Promise((function(a,E){return i(n,void 0,void 0,(function(){var n,i;return o(this,(function(o){switch(o.label){case 0:return n=s.msgSuffix.concat("getP2PHistoryMsg"),[4,new c({url:e.GATEWAY_ADDRESS,timeout:e.GATEWAY_CONNECT_TIMEOUT}).post(n,r(r({},t),{sessId:s._sessionId,appId:s._appid})).then((function(e){return e}))];case 1:return i=o.sent(),a(i),[2]}}))}))}))},t}(),O=function(){function e(e){if(this._websocket=null,this._url="",this._wss=!0,this._port=443,this._listenCallback=[],this.onclose=function(){},this.onerror=function(){},this.onmessage=function(){},e&&"[object Object]"===Object.prototype.toString.call(e)){var t=e.url,n=e.wss,r=e.port;t&&(this._url=t),"boolean"==typeof n&&(this._wss=n),r&&(this._port=r)}}return Object.defineProperty(e.prototype,"connectState",{get:function(){return this._websocket?this._websocket.readyState:WebSocket.CLOSED},enumerable:!1,configurable:!0}),e.prototype.open=function(e){var t=this;return new Promise((function(n,r){if(t._websocket&&d.error("ERROR: SignalingChannel has already opened."),e&&"[object Object]"===Object.prototype.toString.call(e)){var i=e.url,o=e.wss,s=e.port;i&&(t._url=i),"boolean"==typeof o&&(t._wss=o),s&&(t._port=s)}var a=(t._wss?"wss":"ws")+"://"+t._url+":"+t._port;d.debug("SignalingChannel start connect, url "+a+".");var E=function(){d.debug("Signaling channel opened."),t._websocket.onerror=function(e){d.debug("Signaling channel error."),t.onerror(e)},t._websocket.onclose=function(e){d.debug("Channel closed with code: "+e.code+" reason: "+e.reason),t._websocket=null,t.onclose(e)},n()},_=function(e){t._listenCallback.forEach((function(t){t(e)})),t.onmessage(e)},c=function(e){r(Error("WebSocket error."))};try{wx.getSystemInfo(),t._websocket=wx.connectSocket({url:a,complete:function(){}}),t._websocket.onOpen(E),t._websocket.onMessage(_),t._websocket.onError(c)}catch(e){try{t._websocket=new WebSocket(a),t._websocket.onopen=E,t._websocket.onmessage=_,t._websocket.onerror=c}catch(e){t._websocket=null}}}))},e.prototype.close=function(){this._websocket&&(this._websocket.close(),this._websocket=null)},e.prototype.send=function(e){if("object"!=typeof e)return d.error("signal channel msg must be object."),!1;if(this._websocket)try{return wx.getSystemInfo(),this._websocket.send({data:JSON.stringify(e)})}catch(t){1===this._websocket.readyState&&this._websocket.send(JSON.stringify(e))}},e.prototype.addMessageEventListener=function(e,t){this._websocket&&this._listenCallback.push(e)},e.prototype.removeMessageEventListener=function(e,t){if(this._websocket)for(var n=this._listenCallback.length-1;n>-1;n--)this._listenCallback[n]===e&&this._listenCallback.splice(n,1)},e.prototype.clear=function(){this.close(),this.onerror=function(){},this.onclose=function(){},this.onmessage=function(){},this.addMessageEventListener=function(){},this.removeMessageEventListener=function(){}},e}(),v=function(e){function t(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];var i=e.apply(this,E([],a(n)))||this;i.name="RTMException",i.code=t;var o="Error Code "+t+" - ";return i.message=n[0]?o.concat(n[0]):o,i.data=n[1]?n[1]:{},i}return n(t,e),t}(Error),h=function(e){function t(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];var i=e.apply(this,E([t],a(n)))||this;return i.name="RtmInvalidArgumentError",i}return n(t,e),t}(v);!function(e){function t(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];var i=e.apply(this,E([t],a(n)))||this;return i.name="RtmUnauthenticatedError",i}n(t,e)}(v);var A=function(e){return e.then((function(e){return[null,e]})).catch((function(e){return[e]}))},p={},S=function(){return function(){var e,t,n=void 0,r=navigator.userAgent,i=r.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];"Chrome"===i[1]&&null!=(n=r.match(/(OPR(?=\/))\/?(\d+)/i))&&(i=n),"Safari"===i[1]&&null!=(n=r.match(/version\/(\d+)/i))&&(i[2]=n[1]),~r.toLowerCase().indexOf("qqbrowser")&&null!=(n=r.match(/(qqbrowser(?=\/))\/?(\d+)/i))&&(i=n),~r.toLowerCase().indexOf("micromessenger")&&null!=(n=r.match(/(micromessenger(?=\/))\/?(\d+)/i))&&(i=n),~r.toLowerCase().indexOf("edge")&&null!=(n=r.match(/(edge(?=\/))\/?(\d+)/i))&&(i=n),~r.toLowerCase().indexOf("trident")&&null!=(n=/\brv[ :]+(\d+)/g.exec(r)||[])&&(i=[null,"IE",n[1]]);var o=void 0;try{for(var a=s([{s:"Windows 10",r:/(Windows 10.0|Windows NT 10.0)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows Server 2003",r:/Windows NT 5.2/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows ME",r:/(Win 9x 4.90|Windows ME)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 3.11",r:/Win16/},{s:"Android",r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",r:/OS\/2/},{s:"Search Bot",r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}]),E=a.next();!E.done;E=a.next()){var _=E.value;if(_.r.test(navigator.userAgent)){o=_.s;break}}}catch(t){e={error:t}}finally{try{E&&!E.done&&(t=a.return)&&t.call(a)}finally{if(e)throw e.error}}return{name:i[1],version:i[2],os:o}}()},f=function(){return S().os};p.getBrowserInfo=S,p.getBrowserOS=f,p.isChrome=function(){var e=S();return e.name&&"Chrome"===e.name},p.isSafari=function(){var e=S();return e.name&&"Safari"===e.name},p.isEdge=function(){var e=S();return e.name&&"Edge"===e.name},p.isFireFox=function(){var e=S();return e.name&&"Firefox"===e.name},p.isOpera=function(){var e=S();return e.name&&"OPR"===e.name},p.isQQBrowser=function(){var e=S();return e.name&&"QQBrowser"===e.name},p.isWeChatBrowser=function(){var e=S();return e.name&&"MicroMessenger"===e.name},p.isSupportedPC=function(){var e=f();return"Linux"===e||"Mac OS X"===e||"Mac OS"===e||-1!==e.indexOf("Windows")},p.isSupportedMobile=function(){var e=f();return"Android"===e||"iOS"===e},p.getBrowserVersion=function(){return S().version},p.isChromeKernel=function(){return!!navigator.userAgent.match(/chrome\/[\d]./i)},p.isLegacyChrome=function(){return window.navigator.appVersion&&null!==window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35};var C=!1;try{wx.getSystemInfo()}catch(e){C=p.isChrome()&&p.getBrowserVersion()>=87}var L,m,g=function(e){function t(t){var n=e.call(this)||this;n._cmdEncrypt=!1,n._appId="",n._serverIsWss=!0,n._serverUrl="",n._serverPort=0,n._userId=null,n._connectTimeout=null,n._keepAliveTimeout=null,n._keepALiveInterval=null,n._keepALiveIntervalTime=1e4,n._sendMsgTimeOutInterval=1e4,n._revState="DISCONNECTED",n._curState="DISCONNECTED",n.handleMediaServerEvents=function(){};var r=n;return t&&t.appId&&(r._appId=t.appId),n}return n(t,e),t.prototype.init=function(e){var t=this,n=e.appId,r=e.isWss,i=e.url,o=e.port;t._appId=n,"boolean"==typeof r&&(t._serverIsWss=r),i&&(t._serverUrl=i),o&&(t._serverPort=o)},t.prototype.setAppInfo=function(e){var t=e.appId;this._appId=t},t.prototype.configServer=function(e,t,n){var r=this;r._serverIsWss=e,r._serverUrl=t,r._serverPort=n},t.prototype.connectServer=function(){var e=this,t=this;return new Promise((function(n,r){return i(e,void 0,void 0,(function(){var e,i,s,E=this;return o(this,(function(o){switch(o.label){case 0:return t._emitConnectionState("CONNECTING"),t._setConnectTimeout(),[4,A(t.open({url:t._serverUrl,wss:t._serverIsWss,port:t._serverPort}))];case 1:return e=a.apply(void 0,[o.sent(),2]),(i=e[0])?(t._clearConnectTimeout(),r(i)):(s=(t._serverIsWss?"wss":"ws")+"://"+t._serverUrl+":"+t._serverPort,d.debug("[ws-client] websocket opened: "+s),t._clearConnectTimeout(),t._emitConnectionState("CONNECTED"),t.onmessage=function(e){var n=e.data,r=JSON.parse(n),i=r.Cmd;r.Encrypt;var o=r.Content,s=JSON.parse(o);switch(i){case"KeepAlive":t._clearKeepALiveTimeout();break;case"ReqKeepAlive":E.doKeepAlive();break;case"Login":!C&&t._startKeepAlive();break;default:t.handleMediaServerEvents&&t.handleMediaServerEvents(i,s)}},t.onerror=function(e){d.error("WebSocket with some error ",e)},t.onclose=function(e){var n=e.code,r=e.reason;switch(d.info("serve disconnected...",n),t._clearConnectTimeout(),t._stopKeepAlive(),t._clearKeepALiveTimeout(),n){case 1e3:case 1005:t._emitConnectionState("DISCONNECTED","LEAVE");break;case 3001:t._emitConnectionState("RECONNECTING","NETWORK_ERROR");break;default:d.debug("media ws serve disconnected with code "+n+", reason "+r),"RECONNECTING"!==t._curState&&t._emitConnectionState("RECONNECTING","SERVER_ERROR")}t.clear()},n()),[2]}}))}))}))},t.prototype.doKeepAlive=function(){var e=this,t={Cmd:"KeepAlive"};t.Encrypt=this._cmdEncrypt,t.Content=JSON.stringify({time:Date.now().toString()}),this.send(t),!e._keepAliveTimeout&&(e._keepAliveTimeout=setTimeout((function(){e._stopKeepAlive(),e._clearKeepALiveTimeout(),e.clear(),e._emitConnectionState("RECONNECTING","KEEP_A_LIVE_TIME_OUT")}),2*e._keepALiveIntervalTime))},t.prototype.doOnline=function(e){var t=this;return new Promise((function(n,i){var o=function(e){var r=e.data,s=JSON.parse(r),a=s.Cmd;s.Encrypt;var E=s.Content,_=JSON.parse(E);if("Login"===a){t.removeMessageEventListener(o);var c=_.Code;if(0===c){var u=_.UserId;t._userId=u,n(u)}else d.error("user online failure, code => ",c),i(new v(m.LoginError.LOGIN_ERR_UNKNOWN,"Error Code "+c))}};t.addMessageEventListener(o);var s={Cmd:"Login"};s.AppId=t._appId,s.Encrypt=t._cmdEncrypt;var a=r({},e);C&&(a.SvrKeepAlive=!0),s.Content=JSON.stringify(a),t.send(s)}))},t.prototype.doOffline=function(){var e=this;return new Promise((function(t,n){var r=function(i){var o=i.data,s=JSON.parse(o),a=s.Cmd;s.Encrypt;var E=s.Content,_=JSON.parse(E);if("Logout"===a){e.removeMessageEventListener(r);var c=_.Code;0===c?t():n(c)}};e.addMessageEventListener(r);var i={Cmd:"Logout"};i.Encrypt=e._cmdEncrypt,i.Content="",e.send(i)}))},t.prototype.doQueryOnlineStatus=function(e){var t=this;return new Promise((function(n,r){var i=l(),o=function(e){var r=e.data,s=JSON.parse(r),a=s.Cmd;s.Encrypt;var E=s.Content,_=JSON.parse(E);if("QueryOnlineStatus"===a){var c=_.MsgId,u=_.Status;c===i&&(t.removeMessageEventListener(o),n(u))}};t.addMessageEventListener(o);var s={Cmd:"QueryOnlineStatus"};s.Encrypt=t._cmdEncrypt,s.Content=JSON.stringify({MsgId:i,UserIds:JSON.stringify(e)}),t.send(s)}))},t.prototype.doQueryOnlineSubStatus=function(){var e=this;return new Promise((function(t,n){var r=l(),i=function(n){var o=n.data,s=JSON.parse(o),a=s.Cmd;s.Encrypt;var E=s.Content,_=JSON.parse(E);if("QueryOnlineSubStatus"===a){var c=_.MsgId,u=_.Status;c===r&&(e.removeMessageEventListener(i),t(u))}};e.addMessageEventListener(i);var o={Cmd:"QueryOnlineSubStatus"};o.Encrypt=e._cmdEncrypt,o.Content=JSON.stringify({MsgId:r}),e.send(o)}))},t.prototype.doSubscribeOnlineStatus=function(e){var t=this;return new Promise((function(n,r){var i=l(),o=function(e){var s=e.data,a=JSON.parse(s),E=a.Cmd;a.Encrypt;var _=a.Content,c=JSON.parse(_);if("SubscribeOnlineStatus"===E){var u=c.MsgId,R=c.Code;u===i&&(t.removeMessageEventListener(o),0===R?n():r(R))}};t.addMessageEventListener(o);var s={Cmd:"SubscribeOnlineStatus"};s.Encrypt=t._cmdEncrypt,s.Content=JSON.stringify({MsgId:i,UserIds:JSON.stringify(e)}),t.send(s)}))},t.prototype.doUnSubscribeOnlineStatus=function(e){var t=this;return new Promise((function(n,r){var i=l(),o=function(e){var s=e.data,a=JSON.parse(s),E=a.Cmd;a.Encrypt;var _=a.Content,c=JSON.parse(_);if("UnSubscribeOnlineStatus"===E){var u=c.MsgId,R=c.Code;u===i&&(t.removeMessageEventListener(o),0===R?n():r(R))}};t.addMessageEventListener(o);var s={Cmd:"UnSubscribeOnlineStatus"};s.Encrypt=t._cmdEncrypt,s.Content=JSON.stringify({MsgId:i,UserIds:JSON.stringify(e)}),t.send(s)}))},t.prototype.doSendMsgToPeer=function(e,t,n,r,i){var o=this;void 0===r&&(r=!1),void 0===i&&(i=!1);var s=this;return new Promise((function(a,E){if(s._websocket&&1===s._websocket.readyState){var _=l(),c=setTimeout((function(){}),0),u=function(e){var t=e.data,n=JSON.parse(t),r=n.Cmd;n.Encrypt;var i=n.Content,o=JSON.parse(i);if("MsgStatus"===r){var E=o.MsgId,R=o.Status;E===_&&(c&&clearTimeout(c),0===R?(s.removeMessageEventListener(u),a(!1)):(s.removeMessageEventListener(u),a(!0)))}};s.addMessageEventListener(u);var R={Cmd:"SendMsgToPeer"};R.Encrypt=s._cmdEncrypt,R.Content=JSON.stringify(Object.assign({MsgId:_,FromUId:s._userId,ToUId:t,MsgType:e,MsgBody:n,OfflineMsg:r,HistoryMsg:i,Desc:""})),s.send(R),c=setTimeout((function(){s.removeMessageEventListener(u),c&&clearTimeout(c),E("TimeOut")}),o._sendMsgTimeOutInterval)}else E()}))},t.prototype.doRecvMsgFromPeerAck=function(e,t){var n=this;if(!n._websocket||1!==n._websocket.readyState)return!1;var r={Cmd:"RecvMsgFromPeerAck"};r.Encrypt=n._cmdEncrypt,r.Content=JSON.stringify(Object.assign({MsgId:e,FromUId:t})),n.send(r)},t.prototype.doAddOrUpdateUserAttributes=function(e,t){void 0===t&&(t=!1);var n=this;return new Promise((function(r,i){var o=l(),s=function(e){var t=e.data,a=JSON.parse(t),E=a.Cmd;a.Encrypt;var _=a.Content,c=JSON.parse(_),u=c.MsgId;if("AddOrUpdateUserAttributes"===E&&u===o){var R=c.Code;n.removeMessageEventListener(s),0===R?r():i(R)}};n.addMessageEventListener(s);var a={Cmd:"AddOrUpdateUserAttributes"};a.Encrypt=n._cmdEncrypt,a.Content=JSON.stringify(Object.assign({MsgId:o,SetLocal:t,Attributes:JSON.stringify(e)})),n.send(a)}))},t.prototype.doDeleteUserAttributes=function(e){var t=this;return new Promise((function(n,r){var i=l(),o=function(e){var s=e.data,a=JSON.parse(s),E=a.Cmd;a.Encrypt;var _=a.Content,c=JSON.parse(_);if("DeleteUserAttributes"===E){var u=c.Code,R=c.MsgId;i===R&&(t.removeMessageEventListener(o),0===u?n(!0):r(u))}};t.addMessageEventListener(o);var s={Cmd:"DeleteUserAttributes"};s.Encrypt=t._cmdEncrypt,s.Content=JSON.stringify(Object.assign({MsgId:i,Keys:JSON.stringify(e)})),t.send(s)}))},t.prototype.doClearUserAttributes=function(){var e=this;return new Promise((function(t,n){var r=l(),i=function(o){var s=o.data,a=JSON.parse(s),E=a.Cmd;a.Encrypt;var _=a.Content,c=JSON.parse(_);if("ClearUserAttributes"===E){var u=c.Code;c.MsgId===r&&(e.removeMessageEventListener(i),0===u?t(!0):n(u))}};e.addMessageEventListener(i);var o={Cmd:"ClearUserAttributes"};o.Encrypt=e._cmdEncrypt,o.Content=JSON.stringify(Object.assign({MsgId:r})),e.send(o)}))},t.prototype.doGetUserAttributes=function(e){var t=this;return new Promise((function(n,r){var i=l(),o=function(r){var s=r.data,a=JSON.parse(s),E=a.Cmd;a.Encrypt;var _=a.Content,c=JSON.parse(_);if("QueryAttribKeys"===E){var u=c.QueryUserId,R=c.MsgId,l=c.Attribs;u===e&&i===R&&(t.removeMessageEventListener(o),n(JSON.parse(""!==l?l:[])))}};t.addMessageEventListener(o);var s={Cmd:"GetUserAttributes"};s.Encrypt=t._cmdEncrypt,s.Content=JSON.stringify(Object.assign({MsgId:i,UserId:e})),t.send(s)}))},t.prototype.doGetUserAttributesByKeys=function(e,t){var n=this;return new Promise((function(r,i){var o=l(),s=function(t){var i=t.data,a=JSON.parse(i),E=a.Cmd;a.Encrypt;var _=a.Content,c=JSON.parse(_);if("QueryAttribKeys"===E){var u=c.QueryUserId,R=c.MsgId,l=c.Attribs;u===e&&R===o&&(n.removeMessageEventListener(s),r(JSON.parse(l)))}};n.addMessageEventListener(s);var a={Cmd:"GetUserAttributes"};a.Encrypt=n._cmdEncrypt,a.Content=JSON.stringify(Object.assign({MsgId:o,UserId:e,Keys:t})),n.send(a)}))},t.prototype.doJoinChannel=function(e){var t=this;return new Promise((function(n,r){var i=function(o){var s=o.data,a=JSON.parse(s),E=a.Cmd;a.Encrypt;var _=a.Content,c=JSON.parse(_);if("JoinChannel"===E){var u=c.Code,R=c.ChanId;e===R&&(t.removeMessageEventListener(i),0===u?n():r(u))}};t.addMessageEventListener(i);var o={Cmd:"JoinChannel"};o.Encrypt=t._cmdEncrypt,o.Content=JSON.stringify(Object.assign({ChanId:e})),t.send(o)}))},t.prototype.doSendChannelMsg=function(e,t,n,r){void 0===r&&(r=!1);var i=this;return new Promise((function(o,s){var a=l(),E=function(e){var n=e.data,r=JSON.parse(n),_=r.Cmd;r.Encrypt;var c=r.Content,u=JSON.parse(c);if("SendChannelMsg"===_){var R=u.Code,l=u.ChanId,N=u.MsgId;l===t&&a===N&&(i.removeMessageEventListener(E),0===R?o():s(R))}};i.addMessageEventListener(E);var _={Cmd:"SendChannelMsg"};_.Encrypt=i._cmdEncrypt,_.Content=JSON.stringify(Object.assign({ChanId:t,FromUId:i._userId,MsgId:a,MsgType:e,MsgBody:n,HistoryMsg:r,Desc:""})),i.send(_)}))},t.prototype.doLeaveChannel=function(e){var t=this;return new Promise((function(n,r){var i=function(o){var s=o.data,a=JSON.parse(s),E=a.Cmd;a.Encrypt;var _=a.Content,c=JSON.parse(_);if("LeaveChannel"===E){var u=c.Code,R=c.ChanId;e===R&&(t.removeMessageEventListener(i),0===u?n():r(u))}};t.addMessageEventListener(i);var o={Cmd:"LeaveChannel"};o.Encrypt=t._cmdEncrypt,o.Content=JSON.stringify(Object.assign({ChanId:e})),t.send(o)}))},t.prototype.doAddOrUpdateChanAttributes=function(e){var t=this,n=e.channelId,r=e.attributes,i=e.notify,o=void 0!==i&&i,s=e.isSet,a=void 0!==s&&s;return new Promise((function(e,i){var s=l(),E=function(r){var o=r.data,a=JSON.parse(o),_=a.Cmd;a.Encrypt;var c=a.Content,u=JSON.parse(c);if("AddOrUpdateChanAttributes"===_){var R=u.Code,l=u.MsgId;u.ChanId===n&&s===l&&(t.removeMessageEventListener(E),0===R?e():i(R))}};t.addMessageEventListener(E);var _={Cmd:"AddOrUpdateChanAttributes"};_.Encrypt=t._cmdEncrypt,_.Content=JSON.stringify(Object.assign({MsgId:s,SetChan:a,ChanId:n,Attributes:JSON.stringify(r),Notify:o})),t.send(_)}))},t.prototype.doDeleteChanAttributes=function(e){var t=this,n=e.channelId,r=e.attributeKeys,i=e.notify;return new Promise((function(e,o){var s=l(),a=function(n){var r=n.data,i=JSON.parse(r),E=i.Cmd;i.Encrypt;var _=i.Content,c=JSON.parse(_);if("DeleteChanAttributes"===E){var u=c.Code,R=c.MsgId;c.ChanId,R===s&&(t.removeMessageEventListener(a),0===u?e():o(u))}};t.addMessageEventListener(a);var E={Cmd:"DeleteChanAttributes"};E.Encrypt=t._cmdEncrypt,E.Content=JSON.stringify(Object.assign({MsgId:s,ChanId:n,Keys:JSON.stringify(r),Notify:i})),t.send(E)}))},t.prototype.doGetChanAttributes=function(e){var t=this;return new Promise((function(n,r){var i=l(),o=function(s){var a=s.data,E=JSON.parse(a),_=E.Cmd;E.Encrypt;var c=E.Content,u=JSON.parse(c);if("GetChanAttributes"===_){var R=u.Code,l=u.MsgId,N=u.ChanId,I=u.Attributes;e===N&&i===l&&(t.removeMessageEventListener(o),0===R?n(JSON.parse(""===I?"[]":I)):r(R))}};t.addMessageEventListener(o);var s={Cmd:"GetChanAttributes"};s.Encrypt=t._cmdEncrypt,s.Content=JSON.stringify(Object.assign({MsgId:i,ChanId:e})),t.send(s)}))},t.prototype.doGetChanAttributesByKeys=function(e,t){var n=this;return new Promise((function(r,i){var o=l(),s=function(t){var a=t.data,E=JSON.parse(a),_=E.Cmd;E.Encrypt;var c=E.Content,u=JSON.parse(c);if("GetChanAttributesByKeys"===_){var R=u.Code,l=u.MsgId,N=u.ChanId,I=u.Attributes;e===N&&o===l&&(n.removeMessageEventListener(s),0===R?r(""!==I?JSON.parse(I):[]):i(R))}};n.addMessageEventListener(s);var a={Cmd:"GetChanAttributesByKeys"};a.Encrypt=n._cmdEncrypt,a.Content=JSON.stringify(Object.assign({MsgId:o,ChanId:e,Keys:JSON.stringify(t)})),n.send(a)}))},t.prototype.doClearChanAttributes=function(e){var t=this,n=e.channelId,r=e.notify;return new Promise((function(e,i){var o=l(),s=function(n){var r=n.data,a=JSON.parse(r),E=a.Cmd;a.Encrypt;var _=a.Content,c=JSON.parse(_);if("ClearChanAttributes"===E){var u=c.Code;c.MsgId===o&&(t.removeMessageEventListener(s),0===u?e(!0):i(u))}};t.addMessageEventListener(s);var a={Cmd:"ClearChanAttributes"};a.Encrypt=t._cmdEncrypt,a.Content=JSON.stringify(Object.assign({MsgId:o,ChanId:n,Notify:r})),t.send(a)}))},t.prototype.doGetChanMemberSize=function(e){var t=this;return new Promise((function(n,r){var i=l(),o=function(e){var s=e.data,a=JSON.parse(s),E=a.Cmd;a.Encrypt;var _=a.Content,c=JSON.parse(_);if("GetChanMemberSize"===E){var u=c.Code,R=c.ChanMemSize;c.MsgId===i&&(t.removeMessageEventListener(o),0===u?n(R):r(u))}};t.addMessageEventListener(o);var s={Cmd:"GetChanMemberSize"};s.Encrypt=t._cmdEncrypt,s.Content=JSON.stringify(Object.assign({MsgId:i,ChanIds:JSON.stringify(e)})),t.send(s)}))},t.prototype.doGetChanMembers=function(e){var t=this;return new Promise((function(n,r){var i=l(),o=function(s){var a=s.data,E=JSON.parse(a),_=E.Cmd;E.Encrypt;var c=E.Content,u=JSON.parse(c);if("GetChanMembers"===_){var R=u.Code,l=u.MsgId,N=u.Members,I=u.ChanId;e===I&&i===l&&(t.removeMessageEventListener(o),0===R?n(N):r(R))}};t.addMessageEventListener(o);var s={Cmd:"GetChanMembers"};s.Encrypt=t._cmdEncrypt,s.Content=JSON.stringify(Object.assign({MsgId:i,ChanId:e})),t.send(s)}))},t.prototype.doMakeCall=function(e,t,n){var r=this,i={Cmd:"MakeCall"};i.Encrypt=r._cmdEncrypt,i.Content=JSON.stringify(Object.assign({CallId:e,FromUId:r._userId,ToUId:t,Content:n})),r.send(i)},t.prototype.doCancelCall=function(e,t,n,r){void 0===n&&(n=""),void 0===r&&(r="");var i=this;return new Promise((function(o,s){var a=function(n){var r=n.data,E=JSON.parse(r),_=E.Cmd;E.Encrypt;var c=E.Content,u=JSON.parse(c);if("cancelCallAck"===_){var R=u.Code,l=u.CallId,N=u.FromUId,I=u.ToUId;l===e&&N===i._userId&&I===t&&(i.removeMessageEventListener(a),0===R?o():s(R))}};i.addMessageEventListener(a);var E={Cmd:"CancelCall"};E.Encrypt=i._cmdEncrypt,E.Content=JSON.stringify(Object.assign({CallId:e,FromUId:i._userId,ToUId:t,Reason:n,Content:r})),i.send(E)}))},t.prototype.doAcceptCall=function(e,t,n){var r=this,i={Cmd:"AcceptCall"};i.Encrypt=r._cmdEncrypt,i.Content=JSON.stringify(Object.assign({CallId:e,FromUId:r._userId,ToUId:t,Response:n})),r.send(i)},t.prototype.doRefuseCall=function(e,t,n){var r=this,i={Cmd:"RejectCall"};i.Encrypt=r._cmdEncrypt,i.Content=JSON.stringify(Object.assign({CallId:e,FromUId:r._userId,ToUId:t,Response:n})),r.send(i)},t.prototype.doReNewToken=function(e){var t={Cmd:"RenewAcsToken"};t.Content=JSON.stringify({AcsToken:e}),this.send(t)},t.prototype.disconnectServer=function(e){var t=this;if(t._stopKeepAlive(),t._clearKeepALiveTimeout(),t.clear(),e)switch(e){case"UID_BANNED":t._emitConnectionState("DISCONNECTED","UID_BANNED");break;case"TOKEN_INVALID":t._emitConnectionState("DISCONNECTED","TOKEN_INVALID")}else t._emitConnectionState("DISCONNECTED","LEAVE")},t.prototype._setConnectTimeout=function(){var e=this;e._clearConnectTimeout(),e._connectTimeout=setTimeout((function(){e._emitConnectionState("DISCONNECTING","NETWORK_ERROR")}),1e4)},t.prototype._startKeepAlive=function(){var e=this;e._stopKeepAlive(),e.doKeepAlive(),e._keepALiveInterval=setInterval((function(){e.doKeepAlive()}),e._keepALiveIntervalTime)},t.prototype._stopKeepAlive=function(){var e=this;e._keepALiveInterval&&(clearInterval(e._keepALiveInterval),e._keepALiveInterval=null)},t.prototype._clearConnectTimeout=function(){var e=this;e._connectTimeout&&(clearTimeout(e._connectTimeout),e._connectTimeout=null)},t.prototype._clearKeepALiveTimeout=function(){var e=this;e._keepAliveTimeout&&(clearTimeout(e._keepAliveTimeout),e._keepAliveTimeout=null)},t.prototype._emitConnectionState=function(e,t){"DISCONNECTED"===e&&d.debug("[signal] media websocket closed, reason: "+t),this._revState=this._curState,this._curState=e,this.handleMediaServerEvents&&this.handleMediaServerEvents("connection-state-change",{curState:this._curState,revState:this._revState,reason:t})},t}(O),y=function(){function e(){this._events={}}return e.prototype.on=function(e,t){this._events[e]||(this._events[e]=[]);var n=this._events[e];-1===this._indexOfListener(n,t)&&n.push({listener:t,once:!1})},e.prototype.once=function(e,t){this._events[e]||(this._events[e]=[]);var n=this._events[e];-1===this._indexOfListener(n,t)&&n.push({listener:t,once:!0})},e.prototype.off=function(e,t){this._events[e]||(this._events[e]=[]);var n=this._events[e],r=this._indexOfListener(n,t);-1!==r&&n.splice(r,1)},e.prototype.removeAllListeners=function(e){e?delete this._events[e]:this._events={}},e.prototype.emit=function(e){for(var t,n,r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];this._events[e]||(this._events[e]=[]);var o=this._events[e];try{for(var a=s(o),E=a.next();!E.done;E=a.next()){var _=E.value;_.once&&this.off(e,_.listener),_.listener.apply(this,r||[])}}catch(e){t={error:e}}finally{try{E&&!E.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}},e.prototype._indexOfListener=function(e,t){for(var n=e.length;n--;)if(e[n].listener===t)return n;return-1},e}();!function(e){var t,n,r,i,o,s,a;(t=e.ConnectionChangeReason||(e.ConnectionChangeReason={})).BANNED_BY_SERVER="BANNED_BY_SERVER",t.INTERRUPTED="INTERRUPTED",t.LOGIN="LOGIN",t.LOGIN_FAILURE="LOGIN_FAILURE",t.LOGIN_SUCCESS="LOGIN_SUCCESS",t.LOGIN_TIMEOUT="LOGIN_TIMEOUT",t.LOGOUT="LOGOUT",t.REMOTE_LOGIN="REMOTE_LOGIN",(n=e.ConnectionState||(e.ConnectionState={})).ABORTED="ABORTED",n.CONNECTED="CONNECTED",n.CONNECTING="CONNECTING",n.DISCONNECTED="DISCONNECTED",n.RECONNECTING="RECONNECTING",(r=e.LocalInvitationFailureReason||(e.LocalInvitationFailureReason={})).INVITATION_EXPIRE="INVITATION_EXPIRE",r.NOT_LOGGEDIN="NOT_LOGGEDIN",r.PEER_NO_RESPONSE="PEER_NO_RESPONSE",r.PEER_OFFLINE="PEER_OFFLINE",(i=e.LocalInvitationState||(e.LocalInvitationState={})).ACCEPTED_BY_REMOTE="ACCEPTED_BY_REMOTE",i.CANCELED="CANCELED",i.FAILURE="FAILURE",i.IDLE="IDLE",i.RECEIVED_BY_REMOTE="RECEIVED_BY_REMOTE",i.REFUSED_BY_REMOTE="REFUSED_BY_REMOTE",i.SENT_TO_REMOTE="SENT_TO_REMOTE",(e.MessageType||(e.MessageType={})).TEXT="TEXT",(o=e.PeerOnlineState||(e.PeerOnlineState={})).OFFLINE="OFFLINE",o.ONLINE="ONLINE",o.UNREACHABLE="UNREACHABLE",(e.PeerSubscriptionOption||(e.PeerSubscriptionOption={})).ONLINE_STATUS="ONLINE_STATUS",(s=e.RemoteInvitationFailureReason||(e.RemoteInvitationFailureReason={})).ACCEPT_FAILURE="ACCEPT_FAILURE",s.INVITATION_EXPIRE="INVITATION_EXPIRE",s.PEER_OFFLINE="PEER_OFFLINE",(a=e.RemoteInvitationState||(e.RemoteInvitationState={})).ACCEPTED="ACCEPTED",a.ACCEPT_SENT_TO_LOCAL="ACCEPT_SENT_TO_LOCAL",a.CANCELED="CANCELED",a.FAILURE="FAILURE",a.INVITATION_RECEIVED="INVITATION_RECEIVED",a.REFUSED="REFUSED"}(L||(L={})),function(e){var t,n,r,i,o,s,a,E,_,c,u,R,l,N,I,d,T;(t=e.BasicErrorCode||(e.BasicErrorCode={}))[t.INVALID_OPERATION=1]="INVALID_OPERATION",(n=e.AttributeOperationError||(e.AttributeOperationError={}))[n.ATTRIBUTE_OPERATION_ERR_FAILURE=2]="ATTRIBUTE_OPERATION_ERR_FAILURE",n[n.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT=3]="ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT",n[n.ATTRIBUTE_OPERATION_ERR_SIZE_OVERFLOW=4]="ATTRIBUTE_OPERATION_ERR_SIZE_OVERFLOW",n[n.ATTRIBUTE_OPERATION_ERR_TOO_OFTEN=5]="ATTRIBUTE_OPERATION_ERR_TOO_OFTEN",n[n.ATTRIBUTE_OPERATION_ERR_USER_NOT_FOUND=6]="ATTRIBUTE_OPERATION_ERR_USER_NOT_FOUND",n[n.ATTRIBUTE_OPERATION_ERR_TIMEOUT=7]="ATTRIBUTE_OPERATION_ERR_TIMEOUT",n[n.ATTRIBUTE_OPERATION_ERR_USER_NOT_LOGGED_IN=102]="ATTRIBUTE_OPERATION_ERR_USER_NOT_LOGGED_IN",(r=e.ChannelMessageError||(e.ChannelMessageError={}))[r.CHANNEL_MESSAGE_ERR_FAILURE=1]="CHANNEL_MESSAGE_ERR_FAILURE",r[r.CHANNEL_MESSAGE_ERR_TIMEOUT=2]="CHANNEL_MESSAGE_ERR_TIMEOUT",r[r.CHANNEL_MESSAGE_ERR_TOO_OFTEN=3]="CHANNEL_MESSAGE_ERR_TOO_OFTEN",r[r.CHANNEL_MESSAGE_ERR_INVALID_MESSAGE=4]="CHANNEL_MESSAGE_ERR_INVALID_MESSAGE",r[r.CHANNEL_MESSAGE_ERR_NOT_IN_CHANNEL=5]="CHANNEL_MESSAGE_ERR_NOT_IN_CHANNEL",r[r.CHANNEL_MESSAGE_ERR_USER_NOT_LOGGED_IN=102]="CHANNEL_MESSAGE_ERR_USER_NOT_LOGGED_IN",(i=e.CreateChannelError||(e.CreateChannelError={}))[i.CREATE_CHANNEL_ERR_INVALID_ARGUMENT=1]="CREATE_CHANNEL_ERR_INVALID_ARGUMENT",(o=e.CreateInstanceError||(e.CreateInstanceError={}))[o.CREATE_INSTANCE_ERR_INVALID_ARGUMENT=1]="CREATE_INSTANCE_ERR_INVALID_ARGUMENT",(s=e.GetChannelMemberCountErrCode||(e.GetChannelMemberCountErrCode={}))[s.GET_CHANNEL_MEMBER_COUNT_ERR_FAILURE=1]="GET_CHANNEL_MEMBER_COUNT_ERR_FAILURE",s[s.GET_CHANNEL_MEMBER_COUNT_ERR_INVALID_ARGUMENT=2]="GET_CHANNEL_MEMBER_COUNT_ERR_INVALID_ARGUMENT",s[s.GET_CHANNEL_MEMBER_COUNT_ERR_TOO_OFTEN=3]="GET_CHANNEL_MEMBER_COUNT_ERR_TOO_OFTEN",s[s.GET_CHANNEL_MEMBER_COUNT_ERR_TIMEOUT=4]="GET_CHANNEL_MEMBER_COUNT_ERR_TIMEOUT",s[s.GET_CHANNEL_MEMBER_COUNT_ERR_EXCEED_LIMIT=5]="GET_CHANNEL_MEMBER_COUNT_ERR_EXCEED_LIMIT",s[s.GET_CHANNEL_MEMBER_COUNT_ERR_NOT_INITIALIZED=101]="GET_CHANNEL_MEMBER_COUNT_ERR_NOT_INITIALIZED",s[s.GET_CHANNEL_MEMBER_COUNT_ERR_USER_NOT_LOGGED_IN=102]="GET_CHANNEL_MEMBER_COUNT_ERR_USER_NOT_LOGGED_IN",(a=e.GetMembersError||(e.GetMembersError={}))[a.GET_MEMBERS_ERR_FAILURE=1]="GET_MEMBERS_ERR_FAILURE",a[a.GET_MEMBERS_ERR_REJECTED=2]="GET_MEMBERS_ERR_REJECTED",a[a.GET_MEMBERS_ERR_TIMEOUT=3]="GET_MEMBERS_ERR_TIMEOUT",a[a.GET_MEMBERS_ERR_TOO_OFTEN=4]="GET_MEMBERS_ERR_TOO_OFTEN",a[a.GET_MEMBERS_ERR_NOT_IN_CHANNEL=5]="GET_MEMBERS_ERR_NOT_IN_CHANNEL",a[a.GET_MEMBERS_ERR_USER_NOT_LOGGED_IN=6]="GET_MEMBERS_ERR_USER_NOT_LOGGED_IN",(E=e.InvitationApiCallError||(e.InvitationApiCallError={}))[E.INVITATION_API_CALL_ERR_INVALID_ARGUMENT=1]="INVITATION_API_CALL_ERR_INVALID_ARGUMENT",E[E.INVITATION_API_CALL_ERR_NOT_STARTED=2]="INVITATION_API_CALL_ERR_NOT_STARTED",E[E.INVITATION_API_CALL_ERR_ALREADY_END=3]="INVITATION_API_CALL_ERR_ALREADY_END",E[E.INVITATION_API_CALL_ERR_ALREADY_ACCEPT=4]="INVITATION_API_CALL_ERR_ALREADY_ACCEPT",E[E.INVITATION_API_CALL_ERR_ALREADY_SENT=5]="INVITATION_API_CALL_ERR_ALREADY_SENT",(_=e.JoinChannelError||(e.JoinChannelError={}))[_.JOIN_CHANNEL_ERR_FAILURE=1]="JOIN_CHANNEL_ERR_FAILURE",_[_.JOIN_CHANNEL_ERR_REJECTED=2]="JOIN_CHANNEL_ERR_REJECTED",_[_.JOIN_CHANNEL_ERR_INVALID_ARGUMENT=3]="JOIN_CHANNEL_ERR_INVALID_ARGUMENT",_[_.JOIN_CHANNEL_TIMEOUT=4]="JOIN_CHANNEL_TIMEOUT",_[_.JOIN_CHANNEL_ERR_EXCEED_LIMIT=5]="JOIN_CHANNEL_ERR_EXCEED_LIMIT",_[_.JOIN_CHANNEL_ERR_ALREADY_JOINED=6]="JOIN_CHANNEL_ERR_ALREADY_JOINED",_[_.JOIN_CHANNEL_ERR_TOO_OFTEN=7]="JOIN_CHANNEL_ERR_TOO_OFTEN",_[_.JOIN_CHANNEL_ERR_JOIN_SAME_CHANNEL_TOO_OFTEN=8]="JOIN_CHANNEL_ERR_JOIN_SAME_CHANNEL_TOO_OFTEN",_[_.JOIN_CHANNEL_ERR_USER_NOT_LOGGED_IN=102]="JOIN_CHANNEL_ERR_USER_NOT_LOGGED_IN",_[_.JOIN_CHANNEL_ERR_ABORTED_BY_LEAVE=210]="JOIN_CHANNEL_ERR_ABORTED_BY_LEAVE",_[_.JOIN_CHANNEL_ERR_ALREADY_JOINED_CHANNEL_OF_SAME_ID=211]="JOIN_CHANNEL_ERR_ALREADY_JOINED_CHANNEL_OF_SAME_ID",(c=e.LeaveChannelError||(e.LeaveChannelError={}))[c.LEAVE_CHANNEL_ERR_FAILURE=1]="LEAVE_CHANNEL_ERR_FAILURE",c[c.LEAVE_CHANNEL_ERR_REJECTED=2]="LEAVE_CHANNEL_ERR_REJECTED",c[c.LEAVE_CHANNEL_ERR_NOT_IN_CHANNEL=3]="LEAVE_CHANNEL_ERR_NOT_IN_CHANNEL",c[c.LEAVE_CHANNEL_ERR_USER_NOT_LOGGED_IN=102]="LEAVE_CHANNEL_ERR_USER_NOT_LOGGED_IN",(u=e.LoginError||(e.LoginError={}))[u.LOGIN_ERR_UNKNOWN=1]="LOGIN_ERR_UNKNOWN",u[u.LOGIN_ERR_INVALID_ARGUMENT=2]="LOGIN_ERR_INVALID_ARGUMENT",u[u.LOGIN_ERR_INVALID_APP_ID=3]="LOGIN_ERR_INVALID_APP_ID",u[u.LOGIN_ERR_INVALID_TOKEN=4]="LOGIN_ERR_INVALID_TOKEN",u[u.LOGIN_ERR_TOKEN_EXPIRED=5]="LOGIN_ERR_TOKEN_EXPIRED",u[u.LOGIN_ERR_NOT_AUTHORIZED=6]="LOGIN_ERR_NOT_AUTHORIZED",u[u.LOGIN_ERR_ALREADY_LOGIN=7]="LOGIN_ERR_ALREADY_LOGIN",u[u.LOGIN_ERR_TIMEOUT=8]="LOGIN_ERR_TIMEOUT",u[u.LOGIN_ERR_TOO_OFTEN=9]="LOGIN_ERR_TOO_OFTEN",u[u.LOGIN_ERR_ABORTED_BY_LOGOUT=10]="LOGIN_ERR_ABORTED_BY_LOGOUT",u[u.LOGIN_ERR_GATEWAY_CONNECT_FAILED=11]="LOGIN_ERR_GATEWAY_CONNECT_FAILED",(R=e.LogoutError||(e.LogoutError={}))[R.LOGOUT_ERR_USER_NOT_LOGGED_IN=102]="LOGOUT_ERR_USER_NOT_LOGGED_IN",(l=e.PeerMessageError||(e.PeerMessageError={}))[l.PEER_MESSAGE_ERR_FAILURE=1]="PEER_MESSAGE_ERR_FAILURE",l[l.PEER_MESSAGE_ERR_TIMEOUT=2]="PEER_MESSAGE_ERR_TIMEOUT",l[l.PEER_MESSAGE_ERR_TOO_OFTEN=5]="PEER_MESSAGE_ERR_TOO_OFTEN",l[l.PEER_MESSAGE_ERR_INVALID_USERID=6]="PEER_MESSAGE_ERR_INVALID_USERID",l[l.PEER_MESSAGE_ERR_INVALID_MESSAGE=7]="PEER_MESSAGE_ERR_INVALID_MESSAGE",l[l.PEER_MESSAGE_ERR_USER_NOT_LOGGED_IN=102]="PEER_MESSAGE_ERR_USER_NOT_LOGGED_IN",(N=e.PeerSubscriptionStatusError||(e.PeerSubscriptionStatusError={}))[N.PEER_SUBSCRIPTION_STATUS_ERR_FAILURE=1]="PEER_SUBSCRIPTION_STATUS_ERR_FAILURE",N[N.PEER_SUBSCRIPTION_STATUS_ERR_INVALID_ARGUMENT=2]="PEER_SUBSCRIPTION_STATUS_ERR_INVALID_ARGUMENT",N[N.PEER_SUBSCRIPTION_STATUS_ERR_REJECTED=3]="PEER_SUBSCRIPTION_STATUS_ERR_REJECTED",N[N.PEER_SUBSCRIPTION_STATUS_ERR_TIMEOUT=4]="PEER_SUBSCRIPTION_STATUS_ERR_TIMEOUT",N[N.PEER_SUBSCRIPTION_STATUS_ERR_TOO_OFTEN=5]="PEER_SUBSCRIPTION_STATUS_ERR_TOO_OFTEN",N[N.PEER_SUBSCRIPTION_STATUS_ERR_OVERFLOW=6]="PEER_SUBSCRIPTION_STATUS_ERR_OVERFLOW",N[N.PEER_SUBSCRIPTION_STATUS_ERR_USER_NOT_LOGGED_IN=102]="PEER_SUBSCRIPTION_STATUS_ERR_USER_NOT_LOGGED_IN",(I=e.QueryPeersBySubscriptionOptionError||(e.QueryPeersBySubscriptionOptionError={}))[I.QUERY_PEERS_BY_SUBSCRIPTION_OPTION_ERR_FAILURE=1]="QUERY_PEERS_BY_SUBSCRIPTION_OPTION_ERR_FAILURE",I[I.QUERY_PEERS_BY_SUBSCRIPTION_OPTION_ERR_TIMEOUT=2]="QUERY_PEERS_BY_SUBSCRIPTION_OPTION_ERR_TIMEOUT",I[I.QUERY_PEERS_BY_SUBSCRIPTION_OPTION_ERR_TOO_OFTEN=3]="QUERY_PEERS_BY_SUBSCRIPTION_OPTION_ERR_TOO_OFTEN",I[I.QUERY_PEERS_BY_SUBSCRIPTION_OPTION_ERR_USER_NOT_LOGGED_IN=102]="QUERY_PEERS_BY_SUBSCRIPTION_OPTION_ERR_USER_NOT_LOGGED_IN",(d=e.QueryPeersOnlineStatusError||(e.QueryPeersOnlineStatusError={}))[d.QUERY_PEERS_ONLINE_STATUS_ERR_INVALID_ARGUMENT=0]="QUERY_PEERS_ONLINE_STATUS_ERR_INVALID_ARGUMENT",d[d.QUERY_PEERS_ONLINE_STATUS_ERR_REJECTED=1]="QUERY_PEERS_ONLINE_STATUS_ERR_REJECTED",d[d.QUERY_PEERS_ONLINE_STATUS_ERR_TIMEOUT=2]="QUERY_PEERS_ONLINE_STATUS_ERR_TIMEOUT",d[d.QUERY_PEERS_ONLINE_STATUS_ERR_TOO_OFTEN=3]="QUERY_PEERS_ONLINE_STATUS_ERR_TOO_OFTEN",d[d.QUERY_PEERS_ONLINE_STATUS_ERR_USER_NOT_LOGGED_IN=102]="QUERY_PEERS_ONLINE_STATUS_ERR_USER_NOT_LOGGED_IN",(T=e.RenewTokenError||(e.RenewTokenError={}))[T.RENEW_TOKEN_ERR_FAILURE=1]="RENEW_TOKEN_ERR_FAILURE",T[T.RENEW_TOKEN_ERR_INVALID_ARGUMENT=2]="RENEW_TOKEN_ERR_INVALID_ARGUMENT",T[T.RENEW_TOKEN_ERR_REJECTED=3]="RENEW_TOKEN_ERR_REJECTED",T[T.RENEW_TOKEN_ERR_TOO_OFTEN=4]="RENEW_TOKEN_ERR_TOO_OFTEN",T[T.RENEW_TOKEN_ERR_TOKEN_EXPIRED=5]="RENEW_TOKEN_ERR_TOKEN_EXPIRED",T[T.RENEW_TOKEN_ERR_INVALID_TOKEN=6]="RENEW_TOKEN_ERR_INVALID_TOKEN",T[T.RENEW_TOKEN_ERR_USER_NOT_LOGGED_IN=102]="RENEW_TOKEN_ERR_USER_NOT_LOGGED_IN",T[T.RENEW_TOKEN_ERR_ABORTED_BY_LOGOUT=201]="RENEW_TOKEN_ERR_ABORTED_BY_LOGOUT"}(m||(m={}));var U,M=function(e){function t(t,n){var r=e.call(this)||this;return r.memberCount=0,r.attributes={},r.channelId="",r.client=t,r.channelId=n,r.bindChannelEvents=r._handleChannelEvents.bind(r),r}return n(t,e),t.prototype.getMembers=function(){return i(this,void 0,void 0,(function(){var e,t;return o(this,(function(n){switch(n.label){case 0:return t=(e=this).client._rtmServer,""===this.client.uid?[3,2]:[4,t.doGetChanMembers(e.channelId)];case 1:return[2,n.sent()];case 2:throw new h(m.GetMembersError.GET_MEMBERS_ERR_USER_NOT_LOGGED_IN,"The client is not logged in. Cannot do the operation.")}}))}))},t.prototype.join=function(){return i(this,void 0,void 0,(function(){var e,t;return o(this,(function(n){switch(n.label){case 0:if(e=this,""===this.client.uid)throw new h(m.JoinChannelError.JOIN_CHANNEL_ERR_USER_NOT_LOGGED_IN,"The client is not logged in. Cannot do the operation.");return e.client.channels[e.channelId].joined?[3,3]:(t=e.client._rtmServer)?(t.addMessageEventListener(this.bindChannelEvents),[4,t.doJoinChannel(e.channelId)]):[3,2];case 1:return n.sent(),e.client.channels[e.channelId].joined=!0,d.info("join channel "+e.channelId+" success."),[2];case 2:return[3,4];case 3:throw new v(m.JoinChannelError.JOIN_CHANNEL_ERR_ALREADY_JOINED,"The channel has joined. Cannot rejoin.");case 4:return[2]}}))}))},t.prototype.leave=function(){return i(this,void 0,void 0,(function(){var e,t,n;return o(this,(function(r){switch(r.label){case 0:if(e=this,""===this.client.uid)throw new h(m.JoinChannelError.JOIN_CHANNEL_ERR_USER_NOT_LOGGED_IN,"The client is not logged in. Cannot do the operation.");return(t=e.client.channels[e.channelId]).joined?(n=e.client._rtmServer)?[4,n.doLeaveChannel(e.channelId)]:[3,2]:[3,3];case 1:return r.sent(),t.joined=!1,d.info("leave channel "+e.channelId+" success."),n.removeMessageEventListener(e.bindChannelEvents),[2];case 2:return[3,4];case 3:throw new v(m.LeaveChannelError.LEAVE_CHANNEL_ERR_NOT_IN_CHANNEL,"The channel does not join. Cannot do the operation.");case 4:return[2]}}))}))},t.prototype.sendMessage=function(e,t){return i(this,void 0,void 0,(function(){var n,r,i,s;return o(this,(function(o){switch(o.label){case 0:if(n=this,""===this.client.uid)throw new h(m.ChannelMessageError.CHANNEL_MESSAGE_ERR_USER_NOT_LOGGED_IN,"The client is not logged in. Cannot do the operation.");return n.client.channels[n.channelId].joined?(r=(t||{enableHistoricalMessaging:!1}).enableHistoricalMessaging,(i=n.client._rtmServer)?(s=e.text)?(L.MessageType.TEXT,[4,i.doSendChannelMsg(1,n.channelId,s,r)]):[3,2]:[3,3]):[3,4];case 1:return o.sent(),[2];case 2:throw new h(m.ChannelMessageError.CHANNEL_MESSAGE_ERR_INVALID_MESSAGE,"Message is not valid.");case 3:return[3,5];case 4:throw new v(m.ChannelMessageError.CHANNEL_MESSAGE_ERR_NOT_IN_CHANNEL,"The channel does not join. Cannot do the operation.");case 5:return[2]}}))}))},t.prototype._handleChannelEvents=function(e){var t=e.data,n=this,r=JSON.parse(t),i=r.Cmd;r.Encrypt;var o=r.Content,s=JSON.parse(o);if(s.ChanId===n.channelId)if("RecvMsgFromChan"===i){s.MsgId;var a=s.FromUId,E=s.MsgType,_=s.MsgBody,c={isOfflineMessage:!1,serverReceivedTs:s.SvrTS};if(1===E){var u={text:_};n.emit("ChannelMessage",u,a,c)}}else if("ChanMemberJoin"===i){var R=s.UserId;s.ChanMemSize,n.emit("MemberJoined",R)}else if("ChanMemberLeave"===i){R=s.UserId;s.ChanMemSize,n.emit("MemberLeft",R)}else if("MemSizeChanged"===i){var l=s.MemSize;n.emit("MemberCountUpdated",l)}else if("ChanAttribChanged"===i){var N=s.Attributes,I={};N.map((function(e){var t=e.Key,n=e.Val,r=e.UId,i=e.Time;I[t]={lastUpdateTs:i,lastUpdateUserId:r,value:n}})),n.emit("AttributesUpdated",I)}},t}(y),b=function(e){function t(t,n,r){var i=e.call(this)||this;return i._callId="",i.calleeId="",i.content="",i.state=L.LocalInvitationState.IDLE,i.response="",i.client=t,i._callId=n,i.calleeId=r,i}return n(t,e),t.prototype.cancel=function(){var e=this,t=e.client._rtmServer;if(t)if(e.state===L.LocalInvitationState.ACCEPTED_BY_REMOTE||e.state===L.LocalInvitationState.SENT_TO_REMOTE||e.state===L.LocalInvitationState.FAILURE||e.state===L.LocalInvitationState.RECEIVED_BY_REMOTE){var n=e.state===L.LocalInvitationState.FAILURE?"TimeOut":"";t.doCancelCall(e._callId,e.calleeId,n,e.content),e.state!==L.LocalInvitationState.FAILURE&&e.emit("LocalInvitationCanceled")}else if(e.state===L.LocalInvitationState.IDLE)throw new v(m.InvitationApiCallError.INVITATION_API_CALL_ERR_NOT_STARTED,"The call invitation is not send yet.")},t.prototype.send=function(){var e=this;if(e.state!==L.LocalInvitationState.IDLE){if(e.state===L.LocalInvitationState.SENT_TO_REMOTE)throw new v(m.InvitationApiCallError.INVITATION_API_CALL_ERR_ALREADY_SENT,"The call invitation already sent.");if(e.state===L.LocalInvitationState.ACCEPTED_BY_REMOTE||e.state===L.LocalInvitationState.REFUSED_BY_REMOTE)throw new v(m.InvitationApiCallError.INVITATION_API_CALL_ERR_ALREADY_END,"The call invitation already by accept.")}var t=e.client._rtmServer;t?(e.state=L.LocalInvitationState.SENT_TO_REMOTE,t.doMakeCall(e._callId,e.calleeId,e.content)):e.emit("LocalInvitationFailure",L.LocalInvitationFailureReason.NOT_LOGGEDIN)},t}(y),w=function(e){function t(t,n,r){var i=e.call(this)||this;return i._callId="",i.callerId="",i.content="",i.response="",i._callId=t,i.callerId=n,i.content=r,i.state=L.RemoteInvitationState.INVITATION_RECEIVED,i._timer=setTimeout((function(){i.state===L.RemoteInvitationState.INVITATION_RECEIVED&&(i.state=L.RemoteInvitationState.FAILURE,i.emit("RemoteInvitationFailure",L.RemoteInvitationFailureReason.INVITATION_EXPIRE))}),6e4),i}return n(t,e),t.prototype.accept=function(){var e=this,t=e.client._rtmServer;if(t)if(e.state===L.RemoteInvitationState.INVITATION_RECEIVED)t.doAcceptCall(e._callId,e.callerId,e.response),e.state=L.RemoteInvitationState.ACCEPT_SENT_TO_LOCAL;else{if(e.state===L.RemoteInvitationState.ACCEPTED)throw new v(m.InvitationApiCallError.INVITATION_API_CALL_ERR_ALREADY_ACCEPT,"The call invitation already by accept.");if(e.state===L.RemoteInvitationState.REFUSED)throw new v(m.InvitationApiCallError.INVITATION_API_CALL_ERR_ALREADY_END,"The call invitation already ended.")}this._timer&&clearTimeout(this._timer)},t.prototype.refuse=function(){var e=this,t=e.client._rtmServer;t&&e.state===L.RemoteInvitationState.INVITATION_RECEIVED&&(t.doRefuseCall(e._callId,e.callerId,e.response),e.state=L.RemoteInvitationState.REFUSED,e.emit("RemoteInvitationRefused")),this._timer&&clearTimeout(this._timer)},t}(y),D=function(t){function r(e,n){var r=t.call(this)||this;return r._useWss=!0,r._userAttributes={},r._localCall={},r._remoteCall={},r._sessionId="",r._joinStartTime=0,r.uid="",r.token=null,r.channels={},r.channelAttributesCacheLru={},r._sid=u.generateLowCaseString(32),r._appId=e,r.setParameters(n||{}),r}return n(r,t),r.prototype.addOrUpdateChannelAttributes=function(e,t,n){var r;return i(this,void 0,void 0,(function(){var i,s,a;return o(this,(function(o){switch(o.label){case 0:if(i=this,s=/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/,"string"!=typeof e||!s.test(e))throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"The attributes in the arguments is invalid.");if("[object Object]"!==Object.prototype.toString.call(t)||"{}"===JSON.stringify(t))throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"The attributes in the arguments is invalid.");return Object.keys(t).forEach((function(e){if(null==e||""===e)throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"Invalid attribute key.")})),Object.values(t).map((function(e,t){if(null==e||""===e)throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"Invalid attribute key.")})),""===i.uid?[3,2]:(a=(n||{enableNotificationToChannelMembers:!1}).enableNotificationToChannelMembers,[4,null===(r=i._rtmServer)||void 0===r?void 0:r.doAddOrUpdateChanAttributes({channelId:e,attributes:t,notify:a})]);case 1:return o.sent(),i.channelAttributesCacheLru[e]=t,[2];case 2:throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_USER_NOT_LOGGED_IN,"The client is not logged in.")}}))}))},r.prototype.addOrUpdateLocalUserAttributes=function(e){var t;return i(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:if(n=this,"[object Object]"!==Object.prototype.toString.call(e)||"{}"===JSON.stringify(e))throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"The attributes in the arguments is invalid.");return Object.keys(e).forEach((function(e){if(null==e||""===e)throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"Invalid attribute value.")})),Object.values(e).map((function(e,t){if(null==e||""===e)throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"Invalid attribute key.")})),""===n.uid?[3,2]:[4,null===(t=n._rtmServer)||void 0===t?void 0:t.doAddOrUpdateUserAttributes(e)];case 1:return r.sent(),n._userAttributes=e,[2];case 2:throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_USER_NOT_LOGGED_IN,"The client is not logged in.")}}))}))},r.prototype.clearChannelAttributes=function(e,t){var n;return i(this,void 0,void 0,(function(){var r,i,s;return o(this,(function(o){switch(o.label){case 0:if(r=this,i=/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/,"string"!=typeof e||!i.test(e))throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"The attributes in the arguments is invalid.");return""===r.uid?[3,2]:(s=(t||{enableNotificationToChannelMembers:!1}).enableNotificationToChannelMembers,[4,null===(n=r._rtmServer)||void 0===n?void 0:n.doClearChanAttributes({channelId:e,notify:s})]);case 1:return o.sent(),r.channelAttributesCacheLru[e]&&delete r.channelAttributesCacheLru[e],[2];case 2:throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_USER_NOT_LOGGED_IN,"The client is not logged in.")}}))}))},r.prototype.clearLocalUserAttributes=function(){var e;return i(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return""===(t=this).uid?[3,2]:[4,null===(e=t._rtmServer)||void 0===e?void 0:e.doClearUserAttributes()];case 1:return n.sent(),t._userAttributes={},[2];case 2:throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_USER_NOT_LOGGED_IN,"The client is not logged in.")}}))}))},r.prototype.createChannel=function(e){if("string"!=typeof e||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(e)||"null"===e)throw new h(m.CreateChannelError.CREATE_CHANNEL_ERR_INVALID_ARGUMENT,"The channelId in the arguments is invalid.");var t=new M(this,e);return this.channels[e]={channel:t,joined:!1},t},r.prototype.createLocalInvitation=function(e){if("string"!=typeof e)throw new h(m.InvitationApiCallError.INVITATION_API_CALL_ERR_INVALID_ARGUMENT,"The calleeId in the arguments is invalid.");var t=u.generateLowCaseString(32),n=new b(this,t,e);return this._localCall[t]=n,n},r.prototype.deleteChannelAttributesByKeys=function(e,t,n){var r;return i(this,void 0,void 0,(function(){var i,s,a,E;return o(this,(function(o){switch(o.label){case 0:if(""===(i=this).uid)return[3,2];if(s=/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/,"string"!=typeof e||!s.test(e))throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"The channelId in the arguments is invalid.");if(!(t instanceof Array))throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"The attributeKeys in the arguments is not valid.");return a=(n||{enableNotificationToChannelMembers:!1}).enableNotificationToChannelMembers,[4,null===(r=i._rtmServer)||void 0===r?void 0:r.doDeleteChanAttributes({channelId:e,attributeKeys:t,notify:a})];case 1:return o.sent(),i.channelAttributesCacheLru[e]&&(E=i.channelAttributesCacheLru[e],Object.keys(E).map((function(e){E.hasOwnProperty(e)&&delete E[e]}))),[2];case 2:throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_USER_NOT_LOGGED_IN,"The client is not logged in.")}}))}))},r.prototype.deleteLocalUserAttributesByKeys=function(e){var t;return i(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:if(n=this,!(e instanceof Array))throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"The attributeKeys in the arguments is not valid.");return""===n.uid?[3,2]:[4,null===(t=n._rtmServer)||void 0===t?void 0:t.doDeleteUserAttributes(e)];case 1:return r.sent(),e.map((function(e){n._userAttributes.hasOwnProperty(e)&&delete n._userAttributes[e]})),[2];case 2:throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_USER_NOT_LOGGED_IN,"The client is not logged in.")}}))}))},r.prototype.getChannelAttributes=function(e){var t;return i(this,void 0,void 0,(function(){var n,r,i,s,a;return o(this,(function(o){switch(o.label){case 0:if(n=this,r=/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/,"string"!=typeof e||!r.test(e))throw new h(m.CreateChannelError.CREATE_CHANNEL_ERR_INVALID_ARGUMENT,"The channelId in the arguments is invalid.");return""===n.uid?[3,2]:[4,null===(t=n._rtmServer)||void 0===t?void 0:t.doGetChanAttributes(e)];case 1:return i=o.sent(),s={},a={},i.map((function(e){var t=e.Key,n=e.Val,r=e.UId,i=e.Time;s[t]=n,a[t]={lastUpdateTs:i,lastUpdateUserId:r,value:n}})),n.channelAttributesCacheLru[e]=s,[2,a];case 2:throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_USER_NOT_LOGGED_IN,"The client is not logged in.")}}))}))},r.prototype.getChannelAttributesByKeys=function(e,t){var n;return i(this,void 0,void 0,(function(){var r,i,s,a,E;return o(this,(function(o){switch(o.label){case 0:if(r=this,i=/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/,"string"!=typeof e||!i.test(e))throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"The channelId in the arguments is invalid.");if(!(t instanceof Array))throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"The attributeKeys in the arguments is not valid.");return""===r.uid?[3,2]:[4,null===(n=r._rtmServer)||void 0===n?void 0:n.doGetChanAttributesByKeys(e,t)];case 1:return s=o.sent(),a=r.channelAttributesCacheLru[e]||{},E={},s.map((function(e){var t=e.Key,n=e.Val,r=e.UId,i=e.Time;E[t]={lastUpdateTs:i,lastUpdateUserId:r,value:n},a[t]=n})),[2,E];case 2:throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_USER_NOT_LOGGED_IN,"The client is not logged in.")}}))}))},r.prototype.getChannelMemberCount=function(e){var t;return i(this,void 0,void 0,(function(){var n,r;return o(this,(function(i){switch(i.label){case 0:if(n=this,"[object Array]"!==Object.prototype.toString.call(e))throw new h(m.GetChannelMemberCountErrCode.GET_CHANNEL_MEMBER_COUNT_ERR_INVALID_ARGUMENT,"The channelIds in the arguments is invalid.");if(e.length>32)throw new h(m.GetChannelMemberCountErrCode.GET_CHANNEL_MEMBER_COUNT_ERR_EXCEED_LIMIT,"The channelIds is out of length.");return""===n.uid?[3,4]:n._rtmServer?(r={},[4,null===(t=n._rtmServer)||void 0===t?void 0:t.doGetChanMemberSize(e)]):[3,2];case 1:return i.sent().map((function(e){r[e.ChanId]=e.MemSize})),[2,r];case 2:throw new h(m.GetChannelMemberCountErrCode.GET_CHANNEL_MEMBER_COUNT_ERR_NOT_INITIALIZED,"The RTM server is not initialized yet.");case 3:return[3,5];case 4:throw new h(m.GetChannelMemberCountErrCode.GET_CHANNEL_MEMBER_COUNT_ERR_USER_NOT_LOGGED_IN,"The client is not logged in.");case 5:return[2]}}))}))},r.prototype.getUserAttributes=function(e){var t;return i(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:if(n=this,"string"!=typeof e)throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"The channelId in the arguments is invalid.");return""===n.uid?[3,2]:[4,null===(t=n._rtmServer)||void 0===t?void 0:t.doGetUserAttributes(e)];case 1:return[2,r.sent()];case 2:throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_USER_NOT_LOGGED_IN,"The client is not logged in.")}}))}))},r.prototype.getUserAttributesByKeys=function(e,t){var n;return i(this,void 0,void 0,(function(){var r;return o(this,(function(i){switch(i.label){case 0:if(""===(r=this).uid)return[3,2];if("string"!=typeof e||!(t instanceof Array))throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"arguments is not valid.");return[4,null===(n=r._rtmServer)||void 0===n?void 0:n.doGetUserAttributesByKeys(e,t)];case 1:return[2,i.sent()];case 2:throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_USER_NOT_LOGGED_IN,"The client is not logged in.")}}))}))},r.prototype.login=function(e){var t=this,n=this;if(""!==n.uid)return Promise.reject(new v(m.LoginError.LOGIN_ERR_ALREADY_LOGIN,"The SDK is either logging in or has logged in the RTM system."));var r=e.token,s=e.uid;if(n.uid)return d.warning("already connected to room "+n.uid),Promise.resolve();if(n.connectFuture)return n.connectFuture.promise;if(n.reconnectFuture)return n.connectFuture=n.reconnectFuture,n.connectFuture.promise;return n.connectFuture=new N((function(e,E){return i(t,void 0,void 0,(function(){var t,i,_,c,u,R,l,N,I,T;return o(this,(function(o){switch(o.label){case 0:return n._emitConnectionState(L.ConnectionState.CONNECTING,L.ConnectionChangeReason.LOGIN),t=/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/,""===s||null==s||t.test(s)&&"string"==typeof s&&"null"!==s?r&&"string"!=typeof r?(E(new h(m.LoginError.LOGIN_ERR_INVALID_ARGUMENT,"The uid length must be string within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")),[2]):(this._joinStartTime=Date.now(),n._createRtmServerInstance(),[4,A(n._authGateWay(s,r))]):(E(new h(m.LoginError.LOGIN_ERR_INVALID_ARGUMENT,"The uid length must be string within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")),[2]);case 1:if(i=a.apply(void 0,[o.sent(),2]),_=i[0],c=i[1],!_)return[3,2];switch(u=L.ConnectionChangeReason.LOGIN_FAILURE,_.code){case m.LoginError.LOGIN_ERR_INVALID_ARGUMENT:u=L.ConnectionChangeReason.LOGIN_FAILURE;break;case m.LoginError.LOGIN_ERR_INVALID_APP_ID:u=L.ConnectionChangeReason.BANNED_BY_SERVER;break;case m.LoginError.LOGIN_ERR_TIMEOUT:u=L.ConnectionChangeReason.LOGIN_TIMEOUT}return n._emitConnectionState(L.ConnectionState.DISCONNECTED,u),E(_),[3,4];case 2:return c?e():E(),[4,A(this._gateway.getOfflineMsg({uid:n.uid}))];case 3:if(R=a.apply(void 0,[o.sent(),2]),l=R[0],N=R[1],l)return d.error("get offline message failed"),[2];N&&(I=N.code,T=N.data,0===I&&T.map((function(e){var t=e.msgFrom;e.msgStatus;var r=e.msgType,i=e.msgBody,o={isOfflineMessage:!0,serverReceivedTs:e.msgTs};if(1===r){var s={text:i};n.emit("MessageFromPeer",s,t,o)}}))),o.label=4;case 4:return[2]}}))}))}),(function(){n.clearConnectionFutures(),n._emitConnectionState(L.ConnectionState.CONNECTED,L.ConnectionChangeReason.LOGIN_SUCCESS)})),n.connectFuture.promise},r.prototype.clearConnectionFutures=function(){this.connectFuture=void 0,this.reconnectFuture=void 0},r.prototype.logout=function(){var e;return i(this,void 0,void 0,(function(){return o(this,(function(t){return""!==this.uid&&(null===(e=this._rtmServer)||void 0===e||e.doOffline(),this._rtmServer.disconnectServer(),this._rtmServer.handleMediaServerEvents=function(){},this._rtmServer=void 0,this.uid="",this.channels={},this._localCall={},this._remoteCall={},this._sessionId="",this.token="",this._joinStartTime=0,this._emitConnectionState(L.ConnectionState.DISCONNECTED,L.ConnectionChangeReason.LOGOUT)),[2]}))}))},r.prototype.queryPeersBySubscriptionOption=function(e){var t;return i(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:if(""===this.uid)throw new h(m.QueryPeersBySubscriptionOptionError.QUERY_PEERS_BY_SUBSCRIPTION_OPTION_ERR_USER_NOT_LOGGED_IN,"The client is not logged in. Cannot do the operation");if(!(e in L.PeerSubscriptionOption))throw new h(m.QueryPeersBySubscriptionOptionError.QUERY_PEERS_BY_SUBSCRIPTION_OPTION_ERR_FAILURE,"");return n=[],L.PeerSubscriptionOption.ONLINE_STATUS!==e?[3,2]:[4,null===(t=this._rtmServer)||void 0===t?void 0:t.doQueryOnlineSubStatus()];case 1:r.sent().map((function(e){1===e.Online&&n.push(e.UserId)})),r.label=2;case 2:return[2,n]}}))}))},r.prototype.queryPeersOnlineStatus=function(e){var t;return i(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:if(n={},""===this.uid)return[3,2];if(!(e instanceof Array&&e))throw new v(m.QueryPeersOnlineStatusError.QUERY_PEERS_ONLINE_STATUS_ERR_INVALID_ARGUMENT,"invalid arguments.");return[4,null===(t=this._rtmServer)||void 0===t?void 0:t.doQueryOnlineStatus(e)];case 1:return r.sent().map((function(e){n[e.UserId]=!!e.Online})),[2,n];case 2:throw new v(m.QueryPeersOnlineStatusError.QUERY_PEERS_ONLINE_STATUS_ERR_USER_NOT_LOGGED_IN,"The client is not logged in.")}}))}))},r.prototype.renewToken=function(e){return i(this,void 0,void 0,(function(){var t;return o(this,(function(n){return t=this,[2,new Promise((function(n,r){var i;try{if(""===t.uid)throw new v(m.RenewTokenError.RENEW_TOKEN_ERR_USER_NOT_LOGGED_IN,"renewToken should not be called before user join");if(e&&"string"!=typeof e||!e)return void r(new h(m.RenewTokenError.RENEW_TOKEN_ERR_INVALID_ARGUMENT,"The uid length must be string within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,"));d.info("set new token"),null===(i=t._rtmServer)||void 0===i||i.doReNewToken(e),n()}catch(e){r(e)}}))]}))}))},r.prototype.sendMessageToPeer=function(e,t,n){return i(this,void 0,void 0,(function(){var r,i,s,E,_,c,u,R,l,N;return o(this,(function(o){switch(o.label){case 0:if(i={hasPeerReceived:!1},""===(r=this).uid)return[3,4];if(!t)throw new h(m.PeerMessageError.PEER_MESSAGE_ERR_INVALID_USERID,"The send message arguments are not valid.");if(s=e.text,E=/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/,""!==t&&null!=t&&(!E.test(t)||"string"!=typeof t))throw new h(m.PeerMessageError.PEER_MESSAGE_ERR_INVALID_USERID,"The uid length must be string within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,");return c=(_=n||{enableHistoricalMessaging:!1,enableOfflineMessaging:!1}).enableHistoricalMessaging,u=_.enableOfflineMessaging,s?(L.MessageType.TEXT,[4,A(r._rtmServer.doSendMsgToPeer(1,t,s,u,c))]):[3,2];case 1:if(R=a.apply(void 0,[o.sent(),2]),l=R[0],N=R[1],l)throw"TimeOut"===l?new v(m.PeerMessageError.PEER_MESSAGE_ERR_TIMEOUT):new v(m.PeerMessageError.PEER_MESSAGE_ERR_FAILURE,l);return i.hasPeerReceived=N,[2,i];case 2:throw new v(m.PeerMessageError.PEER_MESSAGE_ERR_INVALID_MESSAGE,"Message is not valid.");case 3:return[3,5];case 4:throw new v(m.PeerMessageError.PEER_MESSAGE_ERR_USER_NOT_LOGGED_IN,"Failed to send the peer-to-peer message. The client is not logged in.");case 5:return[2]}}))}))},r.prototype.setChannelAttributes=function(e,t,n){return i(this,void 0,void 0,(function(){var r,i,s;return o(this,(function(o){switch(o.label){case 0:if(r=this,i=/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/,"string"!=typeof e||!i.test(e))throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"The channelId in the arguments is invalid.");if("[object Object]"!==Object.prototype.toString.call(t))throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"The attributes in the arguments is invalid.");return""===r.uid?[3,3]:(s=(n||{enableNotificationToChannelMembers:!1}).enableNotificationToChannelMembers,r._rtmServer?[4,r._rtmServer.doAddOrUpdateChanAttributes({channelId:e,attributes:t,isSet:!0,notify:s})]:[3,2]);case 1:return o.sent(),r.channelAttributesCacheLru[e]=t,[2];case 2:return[3,4];case 3:throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_USER_NOT_LOGGED_IN,"The client is not logged in.");case 4:return[2]}}))}))},r.prototype.setLocalUserAttributes=function(e){var t;return i(this,void 0,void 0,(function(){var n;return o(this,(function(r){switch(r.label){case 0:if(n=this,"[object Object]"!==Object.prototype.toString.call(e))throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_INVALID_ARGUMENT,"The attributes in the arguments is invalid.");return""===n.uid?[3,2]:(n._userAttributes={},[4,null===(t=n._rtmServer)||void 0===t?void 0:t.doAddOrUpdateUserAttributes(e,!0)]);case 1:return r.sent(),n._userAttributes=e,[3,3];case 2:throw new h(m.AttributeOperationError.ATTRIBUTE_OPERATION_ERR_USER_NOT_LOGGED_IN,"The client is not logged in.");case 3:return[2]}}))}))},r.prototype.setParameters=function(t){var n=this,r=t.logFilter,i=t.confPriCloudAddr,o=t.ConfPriCloudAddr;if(r&&d.setLogLevel(r),i){var s=i.ServerAdd,a=i.Port,E=i.Wss;n._useWss="boolean"!=typeof E||E,s&&(e.GATEWAY_ADDRESS=(n._useWss?"https://"+s:"http://"+s)+(a?":"+a:""))}if(o){s=o.ServerAdd,a=o.Port,E=o.Wss;n._useWss="boolean"!=typeof E||E,s&&(e.GATEWAY_ADDRESS=(n._useWss?"https://"+s:"http://"+s)+(a?":"+a:""))}},r.prototype.subscribePeersOnlineStatus=function(e){var t;return i(this,void 0,void 0,(function(){return o(this,(function(n){if(""!==this.uid){if(!(e instanceof Array&&e))throw new v(m.PeerSubscriptionStatusError.PEER_SUBSCRIPTION_STATUS_ERR_INVALID_ARGUMENT,"invalid arguments.");if(e.length<1||e.length>512)throw new v(m.PeerSubscriptionStatusError.PEER_SUBSCRIPTION_STATUS_ERR_OVERFLOW,"The length of the subscriber must be greater than 0 and less than 512.");return null===(t=this._rtmServer)||void 0===t||t.doSubscribeOnlineStatus(e),[2]}throw new h(m.PeerSubscriptionStatusError.PEER_SUBSCRIPTION_STATUS_ERR_USER_NOT_LOGGED_IN,"The client is not logged in.")}))}))},r.prototype.unsubscribePeersOnlineStatus=function(e){var t;return i(this,void 0,void 0,(function(){return o(this,(function(n){if(""!==this.uid){if(!(e instanceof Array&&e))throw new v(m.PeerSubscriptionStatusError.PEER_SUBSCRIPTION_STATUS_ERR_INVALID_ARGUMENT,"invalid arguments.");if(e.length<1||e.length>512)throw new v(m.PeerSubscriptionStatusError.PEER_SUBSCRIPTION_STATUS_ERR_OVERFLOW,"The length of the subscriber must be greater than 0 and less than 512.");return null===(t=this._rtmServer)||void 0===t||t.doUnSubscribeOnlineStatus(e),[2]}throw new h(m.PeerSubscriptionStatusError.PEER_SUBSCRIPTION_STATUS_ERR_USER_NOT_LOGGED_IN,"The client is not logged in.")}))}))},r.prototype._emitConnectionState=function(e,t){this.emit("ConnectionStateChanged",e,t)},r.prototype._createRtmServerInstance=function(){var e=this,t=this;t._rtmServer||(t._rtmServer=new g),t._rtmServer.handleMediaServerEvents=function(t,n){var r,i=e;if(n.Code,"connection-state-change"===t){var o=n.curState;if(n.reason,"RECONNECTING"===o){i._emitConnectionState(L.ConnectionState.RECONNECTING);var s=i._userAttributes;i._userAttributes={},i._remoteCall={},i._localCall={},i.channelAttributesCacheLru={},Object.keys(i.channels).map((function(e){i.channels[e].joined=!1})),i._rtmServer=void 0,i._createRtmServerInstance(),i._authGateWay(i.uid,i.token).then((function(e){i.setLocalUserAttributes(s),Object.keys(i.channels).map((function(e){i.channels[e].channel.join()})),i._emitConnectionState(L.ConnectionState.CONNECTED)}))}}else if("ForceOffline"===t||"AcsTokenDidExpire"===t){var a="";"ForceOffline"===t?e._emitConnectionState(L.ConnectionState.DISCONNECTED,L.ConnectionChangeReason.REMOTE_LOGIN):"AcsTokenDidExpire"===t&&(a="TOKEN_INVALID",i.emit("TokenDidExpired"),d.debug("[client}] token privilege did expire.")),e._rtmServer.disconnectServer(a),e._rtmServer.handleMediaServerEvents=function(){},e._rtmServer=void 0,e.uid="",e.channels={},e._localCall={},e._remoteCall={},e._sessionId="",e.token=""}else if("AcsTokenWillExpire"===t)i.emit("TokenWillExpired"),d.debug("[client] token privilege will expire.");else if("RecvMsgFromPeer"===t){var E=n.MsgId,_=n.FromUId,c=n.MsgType,u=n.MsgBody,R={isOfflineMessage:!1,serverReceivedTs:n.SvrTS};if(1===c){var l={text:u};i.emit("MessageFromPeer",l,_,R)}null===(r=i._rtmServer)||void 0===r||r.doRecvMsgFromPeerAck(E,_)}else if("PeerOnlineStatus"===t){var N=n.Status,I={};N.map((function(e){I[e.UserId]=e.Online?L.PeerOnlineState.ONLINE:L.PeerOnlineState.OFFLINE})),i.emit("PeersOnlineStatusChanged",I)}else if("MakeCall"===t){var T=n.CallId,O=n.FromUId;n.ToUId;var v=n.Content;(A=new w(T,O,v)).client=i,i._remoteCall[T]=A,i.emit("RemoteInvitationReceived",A)}else if("CancelCall"===t){T=n.CallId,O=n.FromUId;n.ToUId;var h=n.Reason;v=n.Content;(A=i._remoteCall[T])&&(A.state=L.RemoteInvitationState.CANCELED,h?"Offline"===h?A.emit("RemoteInvitationFailure",L.RemoteInvitationFailureReason.PEER_OFFLINE):"TimeOut"===h&&A.emit("RemoteInvitationFailure",L.RemoteInvitationFailureReason.INVITATION_EXPIRE):A.emit("RemoteInvitationCanceled",v))}else if("AcceptCallAck"===t){var A;T=n.CallId;(A=i._remoteCall[T]).state=L.RemoteInvitationState.ACCEPTED,A.emit("RemoteInvitationAccepted")}else if("AcceptCall"===t){T=n.CallId,O=n.FromUId;n.ToUId;var p=n.Response;(f=i._localCall[T]).state=L.LocalInvitationState.ACCEPTED_BY_REMOTE,f.emit("LocalInvitationAccepted",p)}else if("RejectCall"===t){T=n.CallId,O=n.FromUId;n.ToUId;var S=n.Response;(f=i._localCall[T]).state=L.LocalInvitationState.REFUSED_BY_REMOTE,f.emit("LocalInvitationRefused",S)}else if("CallStatus"===t){T=n.CallId,N=n.Status;var f=i._localCall[T];if(1===N)f.state=L.LocalInvitationState.SENT_TO_REMOTE;else if(2===N)f.state=L.LocalInvitationState.RECEIVED_BY_REMOTE,f.emit("LocalInvitationReceivedByPeer");else if(3===N){f.state=L.LocalInvitationState.FAILURE;var C=L.LocalInvitationFailureReason.PEER_OFFLINE;f.emit("LocalInvitationFailure",C)}else if(4===N){f.state=L.LocalInvitationState.FAILURE;var m=L.LocalInvitationFailureReason.PEER_NO_RESPONSE;f.emit("LocalInvitationFailure",m),f.cancel()}}}},r.prototype._authGateWay=function(t,n){var r=this,s=this;return new Promise((function(E,_){return i(r,void 0,void 0,(function(){var r,c,u,R,l,N,d,O,h,p,S,f,C,g,y=this;return o(this,(function(U){switch(U.label){case 0:return r=new T,this._gateway=r,[4,A(r.joinGateway({appid:s._appId,uid:t,token:n||"",wss:s._useWss},this._joinStartTime))];case 1:return c=a.apply(void 0,[U.sent(),2]),u=c[0],R=c[1],u?(u===I.INVALID_PARAMS?_(new v(m.LoginError.LOGIN_ERR_INVALID_ARGUMENT,"gateway connect failed: ")):u===I.DEVELOPER_INVALID||u===I.UID_BANNED||u===I.IP_BANNED||u===I.CHANNEL_BANNED||u===I.APPID_INVALID||u===I.SERVER_NOT_OPEN?_(new v(m.LoginError.LOGIN_ERR_INVALID_APP_ID)):u===I.TOKEN_EXPIRED?_(new v(m.LoginError.LOGIN_ERR_TOKEN_EXPIRED,"You must request a new token from your server and call join to use the new token to join the channel")):u===I.TOKEN_INVALID?_(new v(m.LoginError.LOGIN_ERR_INVALID_TOKEN,"make sure token is right and try again please")):u===I.TIMEOUT?_(new v(m.LoginError.LOGIN_ERR_TIMEOUT)):_(new v(m.LoginError.LOGIN_ERR_UNKNOWN)),[2]):(s.token=n,l=R.addresses,N=R.sessionid,s._sessionId=N,!l||l instanceof Array&&0===l.length?(_(new v(m.LoginError.LOGIN_ERR_UNKNOWN,"gateway connect failed: Can not find service list")),[2]):[4,A(s._connectRtmServer(R,t,n))]);case 2:return d=a.apply(void 0,[U.sent(),2]),O=d[0],h=d[1],O?(_(O),[2]):h?(p={UserId:t,UserSId:s._sid,AcsToken:n||"",SdkVer:e.VERSION,SessionId:s._sessionId},[4,A(s._rtmServer.doOnline(p))]):(Date.now()-s._joinStartTime<e.GATEWAY_RETRY_TIMEOUT?setTimeout((function(){return i(y,void 0,void 0,(function(){var e;return o(this,(function(r){switch(r.label){case 0:return[4,this._authGateWay(t,n)];case 1:return e=r.sent(),E(e),[2]}}))}))}),e.GATEWAY_CONNECT_INTERVAL_TIMES):(_(L.ConnectionChangeReason.LOGIN_FAILURE),s._emitConnectionState(L.ConnectionState.DISCONNECTED,L.ConnectionChangeReason.LOGIN_FAILURE)),[2]);case 3:return S=a.apply(void 0,[U.sent(),2]),f=S[0],C=S[1],f?(null===(g=s._rtmServer)||void 0===g||g.disconnectServer(),s._emitConnectionState(L.ConnectionState.DISCONNECTED,L.ConnectionChangeReason.LOGIN_FAILURE),_(f),[2]):(s.uid=C,E(s.uid),[2])}}))}))}))},r.prototype._connectRtmServer=function(e,t,n){var r=this,E=this,_=e.addresses;e.sessionid;var c=_.filter((function(e){return 0===e.type}));return new Promise((function(e,t){return i(r,void 0,void 0,(function(){var t,n,r,i,_,u,R,l,N,I;return o(this,(function(o){switch(o.label){case 0:t=!1,o.label=1;case 1:o.trys.push([1,6,7,8]),n=s(c),r=n.next(),o.label=2;case 2:return r.done?[3,5]:(i=r.value,d.info("begin connect rtm server ",i),null===(N=E._rtmServer)||void 0===N||N.setAppInfo({appId:E._appId}),null===(I=E._rtmServer)||void 0===I||I.configServer(E._useWss,i.addr,i.port),[4,A(E._rtmServer.connectServer())]);case 3:if(_=a.apply(void 0,[o.sent(),1]),!_[0])return t=!0,[3,5];o.label=4;case 4:return r=n.next(),[3,2];case 5:return[3,8];case 6:return u=o.sent(),R={error:u},[3,8];case 7:try{r&&!r.done&&(l=n.return)&&l.call(n)}finally{if(R)throw R.error}return[7];case 8:return e(t),[2]}}))}))}))},r}(y);!function(t){t.BUILD="",t.ConnectionChangeReason=undefined,t.ConnectionState=undefined,t.END_CALL_PREFIX="",t.LOG_FILTER_ERROR=_.ERROR,t.LOG_FILTER_INFO=_.INFO,t.LOG_FILTER_OFF=_.NONE,t.LOG_FILTER_WARNING=_.WARNING,t.LocalInvitationState=undefined,t.MessageType=undefined,t.PeerOnlineState=undefined,t.PeerSubscriptionOption=undefined,t.RemoteInvitationFailureReason=undefined,t.LocalInvitationFailureReason=undefined,t.RemoteInvitationState=undefined,t.VERSION=e.VERSION,t.createInstance=function(e,t){if(!/^[a-zA-Z0-9]{32}$/.test(e))throw new h(m.CreateInstanceError.CREATE_INSTANCE_ERR_INVALID_ARGUMENT,"The appId in the arguments is invalid.");return new D(e,t)}}(U||(U={}));export{U as ArRTM,b as LocalInvitation,w as RemoteInvitation,M as RtmChannel,D as RtmClient,m as RtmErrorCode,L as RtmStatusCode,U as default};
